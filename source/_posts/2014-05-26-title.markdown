---
layout: post
title: "大規模運営に必要なiBeaconについての正しい知識"
date: 2014-05-26 10:08:09 +0900
comments: true
categories: 
---

　あるプロジェクトでiBeaconを使ったiOSアプリを作ることになったので、Appleのチュートリアルを読んだが詳細についてはあまり書かれていなかった。また、そのためかネット上にはあらゆる誤解を与えてしまう記事が多く見うけられた。

このようなことから、みんなが陥りやすいiBeaconに対する誤解について簡単にまとめておく。

今回のプロジェクトでは以下のような形でBeaconを使用した。 

* Beaconの数は合計60個(全てのBeaconのUUIDとMajor IDは同じであり、Minor IDで識別している)
* 各々のBeaconは最も近いもので3m程度しか離れていない。
* Beaconに近づくと情報を取得できる仕組み。

ネットで多くあげられている誤解（もしくは誤解を生じてしまうトピック)  

1.  iOS7.1以降ではバックグラウンドでもiBeaconが反応する（半分間違いであり、誤解を生む)
2.  最も近いBeaconの取得方法
3.  一度Beaconに反応すると、二度と反応しないような仕組み(不親切)



### 1. iOS7.1以降ではバックグラウンドでもBeaconが反応する（半分間違いであり、誤解を生む)
　iOS7.1以降で確かにBeaconをバックグランドで検知することができるようになった。しかし、それはあくまでユーザーの周りにBeaconがあるかないかを検知するだけである。つまり、ビーコンの範囲に入ったときに呼ばれるEnterRejion/ExitRejionだけを呼ぶことでできるということだ。よって、Beaconとの距離を1秒間隔で取得できるdidRangeBeaconsを呼ぶことは基本的にはフォアグランドではない限りできない（＊すこしの時間ならバックグラウンドでも呼ぶことができる）。つまり、同じUUIDを持ったBeaconが十分に離れていた場合は特に問題にはならないが、Beaconの範囲がかぶっていた場合はバックグラウンドで各々のBeaconを特定することはできない(初めに検知したBeaconは可能だが、他のBeaconは一度範囲を抜けて、他のビーコンに干渉されないところから範囲に入る必要がある←これをユーザーに委ねるのは無理)。


### 2. 最も近いBeaconの取得方法
　多くのネット記事では、最も近いBeaconの取得方法として、検知しているBeacon群が入っているNSArrayからFirstObjectで取得しているが、これは間違いである。必ずしもFirstObjectが最も近いBeaconであるとは限らないからだ。たくさんのBeaconが周りにあると、反応が鈍くなってしまう。


### 3. 一度Beaconに反応すると、二度と反応しないような仕組み(不親切)
　Beaconは1秒おきに反応するので、一度反応すると２度と反応しないような仕様がネット記事では多く見受けられるが、これは不親切である。Beaconに反応した時刻をDictに保持しておくなどし、間隔をあけると再度反応できるような仕様が望ましい。

